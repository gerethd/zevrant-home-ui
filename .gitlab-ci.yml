default:
  image: "zevrant/gitlab-runner:latest"

#job:
#  only:
#    - master@github.com/zevrant/zevrant-home-ui
#  extends:
#  when: delayed
#  start_in:
#  rules:
#    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"'
#      when: always


before_script:
  - VERSION=`aws ssm get-parameter --name zevrant-home-ui-VERSION`
  - VERSION=` echo $VERSION | jq .Parameter.Value`;
  - chrlen=`expr ${#VERSION} - 1`
  - VERSION=`echo $VERSION | cut -c2-$chrlen`
  - echo $VERSION

stages:
  - test
  - sonarScan
  - imageBuild
  - updateVersion
  - deploy
  


# sonarScan:
#   stage: sonarScan
#   script: bash gradlew sonar --info

# test:
#   stage: test
#   script: bash gradlew test --info

imageBuild:
  stage: imageBuild
  script:
    - bash gradlew assemble -PprojVersion=$VERSION
    - 'PWS=`pwd`'
    - cp build/libs/zevrant-home-ui-$VERSION.jar /storage/jars
    - cp Dockerfile /storage/jars/Dockerfile-$VERSION
    - echo $VERSION > /storage/jars/VERSION
    - "ssh zevrant@192.168.1.209 'cp /storage/jars/* .; VERSION=`cat VERSION`; docker build --build-arg a_version=$VERSION -t zevrant/zevrant-home-ui:latest-arm -t zevrant/zevrant-home-ui:$VERSION-arm . -f ./Dockerfile-$VERSION'"
    - "ssh zevrant@192.168.1.209 'docker push zevrant/zevrant-home-ui:latest'"
    - "ssh zevrant@192.168.1.209 'VERSION=`cat VERSION`;rm Dockerfile-$VERSION; rm zevrant-home-ui-$VERSION.jar; docker push zevrant/zevrant-home-ui:$VERSION-arm; docker push zevrant/zevrant-home-ui:latest-arm'"
    - 'git tag zevrant-home-ui-$VERSION'
    - cd /storage/jars; docker build --build-arg a_version=$VERSION -t zevrant/zevrant-home-ui:latest -t zevrant/zevrant-home-ui:$VERSION .
    - docker push zevrant/zevrant-home-ui:latest zevrant/zevrant-home-ui:$VERSION
    - rm /storage/jars/zevrant-home-ui-$VERSION.jar

updateVersion:
  stage: updateVersion
  script:
    - IFS='.'
    - read -ra arr <<< "$VERSION"
    - minorVersion=$( expr ${arr[2]} + 1 )
    - aws ssm put-parameter --name zevrant-home-ui-VERSION --value ${arr[0]}.${arr[1]}.$minorVersion --type String --overwrite

deploy:
  stage: deploy
  script:
    - VERSION=$VERSION docker stack deploy --compose-file docker-compose.yml zevrant-home-ui
